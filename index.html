<html>
    <header>
        <title id="title">Light Sources</title>
    </header>
    <body>
        <div id="light-sources">
        </div>
        <div class="new-light">
            <div>
                <div>Title: </div>
                <input type="text" id="title" placeholder="Title">
            </div>
            <div>
                <div>Keeper: </div>
                <input type="text" id="keeper" placeholder="Keeper">
            </div>
            <div>
                <div>Icon: </div>
                <select name="image" id="image">
                    <option value="torch">Torch</option>
                    <option value="lantern">Lantern</option>
                    <option value="magic">Magic</option>
                </select>
            </div>
            <button onclick="addLight()">Add new light</button>
            <div style="border-top: solid 2px; margin-top: 40px;"></div>
            <button style="margin-top: 40px" onclick="downloadJsonFile()">Save to JSON</button>
            <div style="margin-top: 10px" onchange="loadFromJson(event)">
                <div>Load from JSON:</div>
                <input type="file" id="load-json"></div>
            </div>
        </div>
    </body>
</html>
<script src="lib/HackTimer.min.js"></script>
<script>
    var lightSourcesDiv = document.getElementById('light-sources');
    var lightSources = [];

    setInterval(() => {
        for (let index = 0; index < lightSources.length; index++) {
            countTime(index);
            var timerDiv = document.getElementById('timer-' + index);
            timerDiv.innerHTML = formatTime(lightSources[index].seconds);
            
            if(lightSources[index].seconds <= 600) {
                timerDiv.classList.add("red-timer");
            }

            document.getElementById('title').innerHTML = formatTime(lightSources[0].seconds) + " - Shadowdark Light Sources";
        }
    }, 1000);

    function loadFromJson(file) {
        const reader = new FileReader();

        reader.onload = (e) => {
            const fileContent = e.target.result; // The content of the file
            lightSources = JSON.parse(fileContent);
            updateDivs()
        };

        reader.readAsText(document.getElementById("load-json").files[0]);
    }

    function downloadJsonFile() {
        const jsonString = JSON.stringify(lightSources, null, 2);
        const blob = new Blob([jsonString], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");

        a.href = url;
        a.download = "shadowdark-light-sources.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a); 
        URL.revokeObjectURL(url);
    }

    function addLight() {
        lightSources.push({
            title: document.getElementById('title').value,
            image: document.getElementById('image').value,
            keeper: document.getElementById('keeper').value,
            seconds: 3600,
            pause: false
        });
        updateDivs()
    }

    function removeLight(index) {
        lightSources.splice(index, 1);
        updateDivs()
    } 

    function countTime(index) {
        if(lightSources[index].pause) {
            return;
        }

        lightSources[index].seconds--;

        if(lightSources[index].seconds <= 0) {
            lightSources[index].pause = true;
            updateDivs()
            return;
        }
    }

    function formatTime(total_seconds) {
        var seconds = total_seconds;
        var hours = Math.floor(seconds / (60*60));
        seconds -= hours   * (60*60);
        var minutes  = Math.floor(seconds / (60));
        seconds -= minutes * (60);

        if(hours <= 9) {
            if(hours < 0) {
                if(hours >= -9) {
                    hours = "-0" + (hours * -1);
                }
            } else {
                hours = "0" + hours;
            }
        }

        if(minutes <= 9) {
            minutes = "0" + minutes;
        }

        if(seconds <= 9) {
            seconds = "0" + seconds;
        }

        return hours + ":" + minutes + ":" + seconds;
    }

    function updateDivs() {
        var innerHtml = "";

        for (let index = 0; index < lightSources.length; index++) {
            innerHtml += 
                "<div class='light-source'>"
                    + "<div>"
                        + "<button id='delete-" + index + "' onclick='removeLight(" + index + ")'>Delete</button>"
                    + "</div>"
                    + "<div class='light-source-title'>"
                        + lightSources[index].title
                    + "</div>"
                    + "<div class='light-source-image'>"
                        + "<img height='200px' src='images/" + lightSources[index].image + ".png'>"
                    + "</div>"
                    + "<div>"
                        + "<div> Keeper: " + lightSources[index].keeper + "</div>"
                        + "<div>"
                            + "<input id='keeper-" + index + "' placeholder='New keeper' style='margin-right: 10px'>"
                            + "<button id='update-" + index + "' onclick='updateKeeper(" + index + ")'>Update</button>"
                        + "</div>"
                    + "</div>"
                    + "<div class='light-source-timer'>"
                        + "<div class='timer' id='timer-" + index + "'>"
                            + formatTime(lightSources[index].seconds)
                        + "</div>"
                        + "<div>"
                            + "<button id='pause-" + index + "' onclick='pauseResume(" + index + ")'>" + pauseButtonText(index) + "</button>"
                        + "</div>"
                    + "</div>"
                + "</div>";

            innerHtml += "<br>";
        }
        lightSourcesDiv.innerHTML = innerHtml;
    }

    function pauseButtonText(index) {
        if(lightSources[index].seconds == 0) {
            return "Reset";
        }

        if(lightSources[index].pause) {
            return "Resume";
        }

        return "Pause";
    }

    function pauseResume(index) {
        lightSources[index].pause = !lightSources[index].pause;
        
        if(lightSources[index].seconds <= 0) {
            lightSources[index].seconds = 3600;
        }

        updateDivs();
    }

    function updateKeeper(index) {
        var keeperInput = document.getElementById('keeper-' + index);

        lightSources[index].keeper = keeperInput.value; 
        keeperInput.value = "";

        updateDivs();
    }
</script>
<style>
    #light-sources {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
    }
    .light-source {
        margin: 10px;
        border: 3px black solid;
        padding: 10px;
        background: white;
    }
    .light-source-title {
        text-align: center;
    }
    .light-source-image {
        width: 100%;
        display: flex;
        justify-content: center;
    }
    .light-source-timer {
        width: 100%;
        display: flex;
        margin-top: 20px;
        flex-direction: column;
        align-content: center;
        align-items: center;
    }
    .new-light {
        border: 3px solid;
        padding: 20px;
        display: flex;
        flex-direction: column;
        background: white;
        width: 300px;
        margin-right: auto;
        margin-left: auto;
    }
    .new-light input {
        margin-bottom: 10px;
    }

    .new-light select {
        margin-bottom: 10px;
    }
    .red-timer {
        color: red;
    }
    .timer {
        font-size: 30px;
    }
    button {
        background: white;
        font-weight: bolder;
    }
    input {
        border-top: none;
        border-left: none;
        border-right: none;
        border-bottom: solid;
        font-weight: bolder;
    }
    select {
        border: solid;
        font-weight: bolder;
    }
    div {
        font-weight: bolder;
    }
    body {
        background: #e1e1e1;
    }
</style>
